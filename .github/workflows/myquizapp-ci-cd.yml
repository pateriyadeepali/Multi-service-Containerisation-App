  deploy-to-azure-vm:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Start ssh-agent and add private key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

      - name: Deploy to Azure VM
        env:
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          VM_USER: ${{ secrets.AZURE_VM_USERNAME }}
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "ðŸ”— Connecting to $VM_HOST as $VM_USER ..."
          ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST bash -s <<EOF
set -e

echo "âœ… Logged in as \$(whoami)"
echo "ðŸ‘¤ VM user variable received: $VM_USER"
echo "ðŸ³ Docker user: $DOCKER_USER"

# Ensure Docker is installed
if ! command -v docker &> /dev/null; then
  echo "Installing Docker..."
  sudo apt-get update -y
  sudo apt-get install -y docker.io docker-compose-plugin
  sudo systemctl enable docker
  sudo systemctl start docker
fi

WORK_DIR="/home/$VM_USER/myquizapp"
echo "ðŸ“‚ Using working directory: \$WORK_DIR"
sudo mkdir -p \$WORK_DIR
sudo chown -R \$VM_USER:\$VM_USER \$WORK_DIR
cd \$WORK_DIR

# Create docker-compose.yml fresh
cat > docker-compose.yml <<'EOC'
version: "3.9"
services:
  backend:
    image: __DOCKER_USER__/myquizapp-backend:latest
    ports:
      - "8010:8000"
  frontend:
    image: __DOCKER_USER__/myquizapp-frontend:latest
    ports:
      - "8081:80"
EOC

# Replace placeholder with actual docker username
sed -i "s|__DOCKER_USER__|$DOCKER_USER|g" docker-compose.yml

echo "ðŸ› ï¸ Pulling and starting containers..."
docker compose pull
docker compose up -d --remove-orphans

echo "Deployment complete. Running containers:"
docker ps
EOF
